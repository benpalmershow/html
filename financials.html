<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Prevent Caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>Numbers - Howdy, Stranger</title>

    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
    <link rel="manifest" href="site.webmanifest">
    <meta name="theme-color" content="#2C5F5A">

    <link rel="preload" href="css/body.css?v=20250926" as="style">
    <link rel="stylesheet" href="css/dark-mode.css?v=20250926">
    <link rel="stylesheet" href="css/body.css?v=20250926">
    <link rel="stylesheet" href="css/dark-mode.css?v=20250926">
    <link rel="stylesheet" href="css/financials.css?v=20_250926">
    <link rel="stylesheet" href="css/chart-modal.css?v=20250107">

    <script defer src="/_vercel/insights/script.js"></script>
    <script defer src="@vercel/speed-insights/script.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- Chart.js for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Infogram Embed Script -->
    <script>
        ! function (e, n, i, s) {
            var d = "InfogramEmbeds";
            var o = e.getElementsByTagName(n)[0];
            if (window[d] && window[d].initialized)
                window[d].process && window[d].process();
            else if (!e.getElementById(i)) {
                var r = e.createElement(n);
                r.async = 1,
                    r.id = i,
                    r.src = s,
                    o.parentNode.insertBefore(r, o)
            }
        }(document, "script", "infogram-async",
            "https://e.infogram.com/js/dist/embed-loader-min.js");
    </script>

    <!-- Financials Chart JavaScript -->
    <script src="js/financials-chart.js"></script>

</head>

<body>

    <nav class="nav-links" id="main-nav"></nav>
    <h1 class="page-title">Numbers</h1>
    <div id="lastUpdated" class="last-updated" style="text-align:center;"></div>
    <div class="container">
        <div class="collapsible-container">

            <div class="collapsible-content" id="interactive-dashboard-content">
                <div class="filters" id="filters">
                    <button class="filter-btn active" data-category="all">All Categories</button>
                </div>

                <div class="categories" id="categories"></div>

                <!-- Chart Modal Popup -->
                <div id="chartModal" class="chart-modal">
                    <div class="chart-modal-content">
                        <div class="chart-modal-header">
                            <h3>
                                <i data-lucide="trending-up"></i>
                            </h3>
                            <button id="closeChartModal">&times;</button>
                        </div>
                        <div class="chart-modal-body">
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <script>
            let financialData = null;

            // Collapsible functionality
            function toggleCollapse(sectionId) {
                const content = document.getElementById(sectionId + '-content');
                const toggle = document.getElementById(sectionId + '-toggle');

                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    toggle.classList.remove('collapsed');
                    toggle.textContent = '▼';
                } else {
                    content.classList.add('collapsed');
                    toggle.classList.add('collapsed');
                    toggle.textContent = '▲';
                }
            }

            async function fetchFinancialData() {
                const paths = [
                    '/html/json/financials-data.json',
                    '/json/financials-data.json',
                ];

                // Use Promise.any for better performance - returns first successful fetch
                try {
                    const fetchPromises = paths.map(async path => {
                        const response = await fetch(path, { 
                            headers: { 'Accept': 'application/json' },
                            cache: 'no-cache' 
                        });
                        if (!response.ok) throw new Error(`Failed to fetch from ${path}`);
                        return response.json();
                    });
                    
                    financialData = await Promise.any(fetchPromises);
                    initializeDashboard();
                } catch (error) {
                    // If all promises were rejected
                    console.error('Could not load financial data from any path:', error);
                    document.getElementById('categories').innerHTML =
                        '<div class="error">Error loading financial data. Please try again later.</div>';
                }
            }

            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            function getChangeClass(change) {
                if (change === "—" || change === "0" || change === "0.00") return 'change-neutral';
                if (change.startsWith('+')) return 'change-positive';
                if (change.startsWith('-')) return 'change-negative';
                return 'change-neutral';
            }

            function getArrowClass(change) {
                if (change === "—" || change === "0" || change === "0.00") return '';
                if (change.startsWith('+')) return 'arrow-up';
                if (change.startsWith('-')) return 'arrow-down';
                return '';
            }

            // Helper function to extract numeric value from string
            function extractNumericValue(value) {
                if (!value || value === '' || value.startsWith('TBD') || value === '—') return null;

                // Remove common prefixes and suffixes
                let cleanValue = value.toString()
                    .replace(/[$,%]/g, '') // Remove $ and %
                    .replace(/[+\-]/g, '') // Remove + and - signs
                    .replace(/[A-Za-z]/g, '') // Remove letters (M, B, etc.)
                    .trim();

                // Handle special cases like "134,391M" -> "134391"
                if (value.includes('M')) {
                    cleanValue = cleanValue.replace(/M$/, '');
                }
                if (value.includes('B')) {
                    cleanValue = cleanValue.replace(/B$/, '');
                }

                const num = parseFloat(cleanValue);
                return isNaN(num) ? null : num;
            }

            // Calculate Month-over-Month (MoM) change
            function calculateMoMChange(indicator) {
                const months = ['february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october',
                    'november', 'december'
                ];
                let currentValue = null;
                let previousValue = null;
                let currentRawValue = '';

                // Find the latest available value and the previous one
                for (let i = months.length - 1; i >= 0; i--) {
                    const month = months[i];
                    const value = indicator[month];

                    if (value && value !== '' && !value.startsWith('TBD')) {
                        if (currentValue === null) {
                            currentValue = extractNumericValue(value);
                            currentRawValue = value;
                        } else if (previousValue === null) {
                            previousValue = extractNumericValue(value);
                            break;
                        }
                    }
                }

                if (currentValue === null || previousValue === null || previousValue === 0) {
                    return null;
                }

                const change = ((currentValue - previousValue) / previousValue) * 100;
                const numberChange = currentValue - previousValue;

                // Return both percentage change and number change
                return {
                    percentChange: change,
                    numberChange: numberChange,
                    currentRawValue: currentRawValue
                };
            }

            // Calculate all monthly changes for all indicators
            function calculateAllMonthlyChanges(indicator) {
                const months = ['february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october',
                    'november', 'december'
                ];
                const changes = [];

                for (let i = 1; i < months.length; i++) {
                    const currentMonth = months[i];
                    const previousMonth = months[i - 1];

                    const currentValue = extractNumericValue(indicator[currentMonth]);
                    const previousValue = extractNumericValue(indicator[previousMonth]);

                    if (currentValue !== null && previousValue !== null) {
                        const change = currentValue - previousValue;

                        // Format the change based on the type of indicator
                        let formattedChange;
                        if (Math.abs(change) >= 1000) {
                            // For large numbers (like employment), use thousands separator
                            formattedChange = change >= 0 ? `+${change.toLocaleString()}` : change.toLocaleString();
                        } else {
                            // For smaller numbers, use decimal places if needed
                            formattedChange = change >= 0 ? `+${change.toFixed(2)}` : change.toFixed(2);
                            // Remove unnecessary .00
                            formattedChange = formattedChange.replace('.00', '');
                        }

                        changes.push({
                            month: currentMonth,
                            change: change,
                            formatted: formattedChange
                        });
                    }
                }

                return changes;
            }

            // Calculate Year-over-Year (YoY) change (comparing to same month last year)
            // For now, we'll use a simplified approach since we don't have last year's data
            function calculateYoYChange(indicator) {
                // This would require historical data from previous years
                // For now, return null to indicate no YoY data available
                return null;
            }

            // Format change percentage
            function formatChange(change) {
                if (change === null) return '—';
                const sign = change >= 0 ? '+' : '';
                return `${sign}${change.toFixed(2)}%`;
            }

            // Indicator explanations are now loaded from financials-data.json

            function createIndicatorCard(indicator) {
                const months = ['march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november',
                    'december'
                ];
                const monthLabels = ['Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                let dataRows = '';

                // Calculate MoM and YoY changes
                const momChange = calculateMoMChange(indicator);
                const yoyChange = calculateYoYChange(indicator);

                // Special handling for FOMC BPS indicator
                if (indicator.name.includes('FOMC') && indicator.name.includes('Rate Decision') && indicator
                    .bps_probabilities) {
                    dataRows +=
                        `<div class="data-row"><span class="month-label">Next Meeting:</span> <span class="month-value">${indicator.next_meeting || ''}</span></div>`;
                    Object.entries(indicator.bps_probabilities).forEach(([bps, prob]) => {
                        if (prob && prob !== '') {
                            dataRows += `
                            <div class="data-row">
                                <span class="month-label">${bps}:</span>
                                <span class="month-value">${prob}</span>
                            </div>
                        `;
                        }
                    });
                }
                // Special handling for Recession probability
                else if (indicator.name.includes('Recession')) {
                    if (indicator.yes_probability) {
                        dataRows +=
                            `<div class="data-row"><span class="month-label">Yes:</span> <span class="month-value">${indicator.yes_probability}</span></div>`;
                    }
                    if (indicator.no_probability) {
                        dataRows +=
                            `<div class="data-row"><span class="month-label">No:</span> <span class="month-value">${indicator.no_probability}</span></div>`;
                    }
                }
                // Special handling for NFL predictions (Kalshi style)
                else if (indicator.name.includes('@')) {
                    if (indicator.game_title) {
                        dataRows +=
                            `<div class="data-row"><span class="month-label">Game:</span> <span class="month-value">${indicator.game_title}</span></div>`;
                    }
                    if (indicator.game_time) {
                        if (indicator.game_time_iso) {
                            // For games with ISO timestamp, show a countdown timer with fallback text
                            const gameTimeAttr = indicator.game_time_iso;
                            dataRows +=
                                `<div class="data-row"><span class="month-label">Time:</span> <span class="month-value"><span class="game-countdown" data-game-time="${gameTimeAttr}">${indicator.game_time}</span></span></div>`;
                        } else {
                            // For games without ISO timestamp, show the game time as static text
                            dataRows +=
                                `<div class="data-row"><span class="month-label">Time:</span> <span class="month-value">${indicator.game_time}</span></div>`;
                        }
                    }
                    if (indicator.week) {
                        dataRows +=
                            `<div class="data-row"><span class="month-label">Week:</span> <span class="month-value">${indicator.week}</span></div>`;
                    }

                    // Show team win odds
                    const teamKeys = Object.keys(indicator).filter(key => key.endsWith('_win_odds'));
                    teamKeys.forEach(key => {
                        const teamName = key.replace('_win_odds', '').toUpperCase();
                        dataRows +=
                            `<div class="data-row"><span class="month-label">${teamName} Win:</span> <span class="month-value">${indicator[key]}</span></div>`;
                    });

                    if (indicator.total_points) {
                        dataRows +=
                            `<div class="data-row"><span class="month-label">Total:</span> <span class="month-value">${indicator.total_points}</span></div>`;
                    }
                } else if ((indicator.name === 'Total Nonfarm Employment' && indicator.agency === 'FRED') ||
                    (indicator.name === 'Job Openings')) {
                    // Special handling for Total Nonfarm Employment and Job Openings - show job changes inline
                    const monthlyChanges = calculateAllMonthlyChanges(indicator);
                    const changesMap = {};
                    monthlyChanges.forEach(change => {
                        changesMap[change.month] = change;
                    });

                    months.forEach((month, index) => {
                        const value = indicator[month];
                        const label = monthLabels[index] || month;
                        if (value && value !== '') {
                            // Determine formatted change (if available)
                            const changeObj = changesMap[month];
                            let changeHtml = '';
                            if (changeObj) {
                                // Use the formatted string from calculateAllMonthlyChanges
                                const formatted = changeObj.formatted;
                                // Style positive/negative
                                const changeClass = (changeObj.change >= 0) ? 'change-positive' :
                                    'change-negative';
                                changeHtml =
                                    `<span class="month-change ${changeClass}" style="margin-left:8px; font-weight:600;">${formatted}</span>`;
                            }

                            // Render the row with numeric value and right-aligned monthly change
                            dataRows += `
                                <div class="data-row">
                                    <span class="month-label">${label}:</span>
                                    <span class="month-value">${value}${changeHtml}</span>
                                </div>
                            `;
                        }
                    });
                } else if (indicator.name === 'CPI' && indicator.agency === 'BLS') {
                    // Special handling for CPI - show YoY changes inline
                    const cpiYoyData = {
                        'march': '3.2%',
                        'april': '3.4%',
                        'may': '3.3%',
                        'june': '3.0%',
                        'july': '2.9%',
                        'august': '2.5%'
                    };

                    months.forEach((month, index) => {
                        const value = indicator[month];
                        const label = monthLabels[index] || month;
                        if (value && value !== '') {
                            const yoy = cpiYoyData[month] ?
                                `<span class="month-change" style="margin-left:8px; font-weight:600;">${cpiYoyData[month]}</span>` :
                                '';
                            dataRows += `
                                <div class="data-row">
                                    <span class="month-label">${label}:</span>
                                    <span class="month-value">${value}${yoy}</span>
                                </div>
                            `;
                        }
                    });
                } else {
                    months.forEach((month, index) => {
                        const value = indicator[month];
                        const label = monthLabels[index] || month;
                        if (value && value !== '') {
                            dataRows += `
                                <div class="data-row">
                                    <span class="month-label">${label}:</span>
                                    <span class="month-value">${value}</span>
                                </div>
                            `;
                        }
                    });
                }

                const url = indicator.url || '#';
                const explanation = indicator.explanation || '';

                // Create change indicators section
                let changeIndicators = '';

                // MoM change
                if (momChange !== null) {
                    const momFormatted = formatChange(momChange.percentChange);
                    let changeText = `MoM: ${momFormatted}`;

                    // Add number change for employment indicators
                    if ((indicator.name === 'Private Employment' && indicator.agency === 'ADP') ||
                        (indicator.name === 'Total Nonfarm Employment' && indicator.agency === 'FRED') ||
                        (indicator.name === 'Job Openings')) {
                        const numberChange = momChange.numberChange;
                        const changeSign = numberChange >= 0 ? '+' : '';
                        const formattedNumber = numberChange.toLocaleString();

                        // Add number change for employment indicators
                        changeText += ` (${changeSign}${formattedNumber})`;
                    }

                    const arrowIcon = momChange.percentChange >= 0 ? '<i data-lucide="arrow-up-right"></i>' :
                        '<i data-lucide="arrow-down-right"></i>';
                    const title = indicator.name === 'Total Nonfarm Employment' ?
                        "Latest monthly change in nonfarm payroll employment" :
                        "Month-over-Month (MoM) change calculated from available data.";

                    changeIndicators += `
                    <div class="change-indicator ${getChangeClass(momFormatted)}" title="${title}">
                        <span class="arrow-icon">${arrowIcon}</span> ${changeText}
                    </div>
                `;
                }

                // YoY change (placeholder for future implementation)
                if (yoyChange !== null) {
                    const yoyFormatted = formatChange(yoyChange);
                    const yoyArrowIcon = yoyChange >= 0 ? '<i data-lucide="arrow-up-right"></i>' :
                        '<i data-lucide="arrow-down-right"></i>';
                    changeIndicators += `
                    <div class="change-indicator ${getChangeClass(yoyFormatted)}" title="Year-over-Year (YoY) change.">
                        <span class="arrow-icon">${yoyArrowIcon}</span> YoY: ${yoyFormatted}
                    </div>
                `;
                }

                return `
                <div class="indicator">
                    <div class="indicator-name">
                        ${indicator.name}
                        ${explanation ? `<i data-lucide="info" class="info-icon" data-explanation="${explanation.replace(/"/g, '&quot;')}" title="Show explanation"></i>` : ''}
                        ${indicator.category !== 'Prediction Markets' ? `<i data-lucide="bar-chart-3" class="chart-icon" title="View Interactive Chart"></i>` : ''}
                    </div>
                    <div class="indicator-agency">
                        Source: <a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--text-muted); text-decoration: underline;">${indicator.agency}</a>
                        ${indicator.category === 'Prediction Markets' && indicator.kalshi_url ? ` | <a href="${indicator.kalshi_url}" target="_blank" rel="noopener noreferrer" style="color: var(--text-muted); text-decoration: underline;">Kalshi</a>` : ''}
                        ${indicator.category === 'Prediction Markets' && indicator.polymarket_url ? ` | <a href="${indicator.polymarket_url}" target="_blank" rel="noopener noreferrer" style="color: var(--text-muted); text-decoration: underline;">Polymarket</a>` : ''}
                    </div>
                    ${dataRows}
                    <div class="change-indicators">
                        ${changeIndicators}
                    </div>
                    <div class="explanation-text" style="display: none; margin-top: 8px; padding: 8px; background: var(--bg-secondary, #f5f5f5); border-radius: 4px; font-size: 0.9em; color: var(--text-secondary, #666);"></div>
                </div>
            `;
            }

            // Category icons mapping with Lucide icons
            const categoryIcons = {
                'Employment Indicators': '<i data-lucide="users"></i>',
                'Housing Market': '<i data-lucide="home"></i>',
                'Business Indicators': '<i data-lucide="briefcase"></i>',
                'Consumer Indicators': '<i data-lucide="shopping-cart"></i>',
                'Trade & Tariffs': '<i data-lucide="ship"></i>',
                'Government': '<i data-lucide="landmark"></i>',
                'Commodities': '<i data-lucide="package"></i>',
                'Prediction Markets': '<i data-lucide="trending-up"></i>'
            };

            function setupInfoIconHandlers() {
                document.querySelectorAll('.info-icon').forEach(icon => {
                    icon.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();

                        const indicator = this.closest('.indicator');
                        const explanationDiv = indicator.querySelector('.explanation-text');
                        const explanation = this.dataset.explanation;

                        if (explanationDiv.style.display === 'none') {
                            explanationDiv.textContent = explanation;
                            explanationDiv.style.display = 'block';
                            this.style.color = 'var(--primary-color, #2C5F5A)';
                        } else {
                            explanationDiv.style.display = 'none';
                            this.style.color = 'var(--text-muted)';
                        }
                    });
                });
            }

            function setupJobsIconHandlers() {
                document.querySelectorAll('.jobs-icon').forEach(icon => {
                    icon.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();

                        const indicator = this.closest('.indicator');
                        const dataRows = indicator.querySelectorAll('.data-row');

                        // Check if job changes are already showing
                        const isShowingChanges = indicator.dataset.showingJobChanges === 'true';

                        if (!isShowingChanges) {
                            // Find the indicator data
                            const indicatorData = financialData.indices.find(item =>
                                item.name === 'Total Nonfarm Employment' && item.agency === 'FRED'
                            );

                            if (indicatorData) {
                                const monthlyChanges = calculateAllMonthlyChanges(indicatorData);
                                const months = ['march', 'april', 'may', 'june', 'july', 'august'];
                                const monthLabels = ['Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug'];

                                // Create a map of changes by month
                                const changesMap = {};
                                monthlyChanges.forEach(change => {
                                    changesMap[change.month] = change;
                                });

                                // Add job changes to existing month rows
                                dataRows.forEach(row => {
                                    const monthLabel = row.querySelector('.month-label');
                                    const monthValue = row.querySelector('.month-value');

                                    if (monthLabel && monthValue) {
                                        const monthText = monthLabel.textContent.trim().replace(
                                            ':', '');
                                        const monthIndex = monthLabels.indexOf(monthText);

                                        if (monthIndex >= 0) {
                                            const monthKey = months[monthIndex];
                                            const change = changesMap[monthKey];

                                            if (change) {
                                                const changeClass = change.change >= 0 ?
                                                    'change-positive' :
                                                    'change-negative';
                                                const arrowIcon = change.change >= 0 ? '↗' :
                                                    '↘';

                                                // Add small job change text to the right
                                                const jobChangeSpan = document.createElement(
                                                    'span');
                                                jobChangeSpan.className = 'job-change-inline';
                                                jobChangeSpan.innerHTML =
                                                    ` <span class="${changeClass}" style="font-size: 0.75em; margin-left: 8px; opacity: 0.8;">${arrowIcon}${change.formatted}</span>`;
                                                monthValue.appendChild(jobChangeSpan);
                                            }
                                        }
                                    }
                                });

                                indicator.dataset.showingJobChanges = 'true';
                                this.style.color = 'var(--logo-orange, #D4822A)';
                            }
                        } else {
                            // Remove job changes
                            dataRows.forEach(row => {
                                const jobChangeSpan = row.querySelector('.job-change-inline');
                                if (jobChangeSpan) {
                                    jobChangeSpan.remove();
                                }
                            });

                            indicator.dataset.showingJobChanges = 'false';
                            this.style.color = 'var(--logo-orange, #D4822A)';
                        }
                    });
                });
            }



            function renderDashboard(filterCategory = 'all') {
                const categoriesContainer = document.getElementById('categories');
                const categories = [...new Set(financialData.indices.map(item => item.category))];

                let html = '';

                categories.forEach(category => {
                    if (filterCategory !== 'all' && category !== filterCategory) return;

                    const categoryIndicators = financialData.indices.filter(item => item.category === category);
                    const icon = categoryIcons[category] || '<i data-lucide="bar-chart-2"></i>';

                    html += `
                    <div class="category" data-category="${category}">
                        <h2 class="category-title">
                            <span class="category-icon">${icon}</span>
                            <span class="category-name">${category}</span>
                        </h2>
                        <div class="indicators-grid">
                            ${categoryIndicators.map(indicator => createIndicatorCard(indicator)).join('')}
                        </div>
                    </div>
                `;
                });

                categoriesContainer.innerHTML = html;

                // Re-initialize Lucide icons after updating the content
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                // Add click event listeners for info icons
                setupInfoIconHandlers();
                setupChartIconHandlers();

                // Initialize countdown timers after rendering
                if (typeof updateAllCountdowns === 'function') {
                    updateAllCountdowns();
                }
            }

            function setupFilters() {
                const filtersContainer = document.getElementById('filters');
                const categories = [...new Set(financialData.indices.map(item => item.category))];

                // Clear existing filter buttons
                filtersContainer.innerHTML = '';

                // Create the 'All Categories' button with icon and text
                const allButton = document.createElement('button');
                allButton.className = 'filter-btn active';
                allButton.dataset.category = 'all';
                allButton.setAttribute('aria-label', 'All Categories');
                allButton.innerHTML = `
                    <span class="filter-icon"><i data-lucide="list"></i></span>
                    <span class="filter-text">All Categories</span>
                `;
                allButton.setAttribute('data-tooltip', 'All Categories');
                filtersContainer.appendChild(allButton);

                // Create category filter buttons with icon and text (text shown on hover)
                categories.forEach(category => {
                    const button = document.createElement('button');
                    button.className = 'filter-btn';
                    const icon = categoryIcons[category] || '<i data-lucide="bar-chart-2"></i>';
                    button.innerHTML = `
                        <span class="filter-icon">${icon}</span>
                        <span class="filter-text">${category}</span>
                    `;
                    button.dataset.category = category;
                    button.setAttribute('aria-label', category);
                    button.setAttribute('data-tooltip', category);
                    filtersContainer.appendChild(button);
                });

                // Tooltip logic for hover and mobile/touch
                let tooltip = document.getElementById('filter-tooltip');
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.id = 'filter-tooltip';

                    // Apply all styles at once to ensure they stick
                    Object.assign(tooltip.style, {
                        position: 'fixed',
                        pointerEvents: 'none',
                        zIndex: '2147483647',
                        background: 'rgba(44,95,90,0.97)',
                        color: '#fff',
                        padding: '8px 12px',
                        borderRadius: '6px',
                        fontSize: '0.9em',
                        fontWeight: '500',
                        boxShadow: '0 4px 12px rgba(0,0,0,0.25)',
                        transition: 'opacity 0.2s ease',
                        opacity: '0',
                        display: 'none',
                        whiteSpace: 'nowrap',
                        maxWidth: '200px',
                        textAlign: 'center',
                        isolation: 'isolate',
                        transform: 'translateZ(0)',
                        willChange: 'transform, opacity',
                        backfaceVisibility: 'hidden',
                        WebkitBackfaceVisibility: 'hidden',
                        WebkitTransform: 'translateZ(0)',
                        WebkitPerspective: '1000',
                        perspective: '1000px'
                    });

                    document.body.appendChild(tooltip);
                }

                function showTooltip(text, x, y) {
                    tooltip.textContent = text;
                    tooltip.style.display = 'block';

                    // Get actual tooltip dimensions after setting text
                    const tooltipRect = tooltip.getBoundingClientRect();
                    const tooltipWidth = tooltipRect.width;

                    // Center the tooltip horizontally and position it above the button
                    tooltip.style.left = Math.max(10, x - tooltipWidth / 2) + 'px';
                    tooltip.style.top = (y - 40) + 'px';
                    tooltip.style.opacity = '1';

                    // Force reflow and ensure tooltip is on top
                    tooltip.style.zIndex = '2147483647';
                    tooltip.style.position = 'fixed';
                    tooltip.style.pointerEvents = 'none';
                    tooltip.style.isolation = 'isolate';
                    tooltip.style.transform = 'translateZ(0)';
                }

                function hideTooltip() {
                    tooltip.style.opacity = '0';
                    tooltip.style.display = 'none';
                    tooltip.dataset.activeButton = '';
                }

                // Combined click handler for filter buttons and tooltips
                filtersContainer.addEventListener('click', function (e) {
                    const btn = e.target.closest('.filter-btn');
                    if (btn) {
                        // Handle tooltip toggle on double-click or long press
                        if (e.detail === 2 && btn.dataset.tooltip) { // Double-click
                            const rect = btn.getBoundingClientRect();
                            tooltip.dataset.activeButton = btn.dataset.category;

                            requestAnimationFrame(() => {
                                showTooltip(btn.dataset.tooltip, rect.left + rect.width / 2, rect.top);
                            });

                            // Auto-hide after 3 seconds
                            setTimeout(() => {
                                if (tooltip.dataset.activeButton === btn.dataset.category) {
                                    hideTooltip();
                                }
                            }, 3000);
                            return;
                        }

                        // Handle filter change (single click)
                        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                        btn.classList.add('active');
                        renderDashboard(btn.dataset.category);

                        // Hide any existing tooltip
                        hideTooltip();
                    }
                });

                // Hide tooltip when clicking outside
                document.addEventListener('click', function (e) {
                    if (!filtersContainer.contains(e.target)) {
                        hideTooltip();
                    }
                });

                // Initialize Lucide icons after creating filter buttons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }

            function initializeDashboard() {
                document.getElementById('lastUpdated').textContent =
                    `Last Updated: ${formatDate(financialData.lastUpdated)}`;
                setupFilters();
                renderDashboard();
                setupModalHandlers();
            }

            // Initialize dashboard
            document.addEventListener('DOMContentLoaded', function () {
                fetchFinancialData();
                // Initialize Lucide icons when DOM is ready
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            });
        </script>
        <script src="js/dark-mode.js?v=20250926" defer></script>
        <script src="js/nav.js?v=20250926" defer></script>
        <script src="js/countdown.js?v=20250926" defer></script>
        <div id="last-updated" style="text-align: center; margin-top: 2rem; color: #666; font-size: 0.9em;"></div>
        <script>
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        </script>
</body>

</html>