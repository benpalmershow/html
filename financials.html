<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Numbers - Howdy, Stranger</title>

    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
    <link rel="manifest" href="site.webmanifest">
    <meta name="theme-color" content="#2C5F5A">

    <link rel="preload" href="css/body.min.css" as="style">
    <link rel="stylesheet" href="css/dark-mode.css">
    <link rel="stylesheet" href="css/body.min.css">
    <link rel="stylesheet" href="css/dark-mode.css">
    <link rel="stylesheet" href="css/financials.min.css">
    <link rel="stylesheet" href="css/chart-modal.css">
    
    <script defer src="/_vercel/insights/script.js"></script>
    <script defer src="@vercel/speed-insights/script.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Chart.js for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Infogram Embed Script -->
    <script>
        !function(e,n,i,s){
            var d="InfogramEmbeds";
            var o=e.getElementsByTagName(n)[0];
            if(window[d]&&window[d].initialized)
                window[d].process&&window[d].process();
            else if(!e.getElementById(i)){
                var r=e.createElement(n);
                r.async=1,
                r.id=i,
                r.src=s,
                o.parentNode.insertBefore(r,o)
            }
        }(document,"script","infogram-async",
          "https://e.infogram.com/js/dist/embed-loader-min.js");
    </script>
    
    <!-- Financials Chart JavaScript -->
    <script src="js/financials-chart.js"></script>

</head>

<body>

    <nav class="nav-links" id="main-nav"></nav>
    <h1 class="page-title">Numbers</h1>
    <div id="lastUpdated" class="last-updated" style="text-align:center;"></div>
    <div class="container">
        <div class="collapsible-container">

            <div class="collapsible-content" id="interactive-dashboard-content">
                <div class="filters" id="filters">
                    <button class="filter-btn active" data-category="all">All Categories</button>
                </div>

                <div class="categories" id="categories"></div>
                
                <!-- Chart Modal Popup -->
                <div id="chartModal" class="chart-modal">
                    <div class="chart-modal-content">
                        <div class="chart-modal-header">
                            <h3>
                                <i data-lucide="trending-up"></i>
                            </h3>
                            <button id="closeChartModal">&times;</button>
                        </div>
                        <div class="chart-modal-body">
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <script>
            let financialData = null;

            // Collapsible functionality
            function toggleCollapse(sectionId) {
                const content = document.getElementById(sectionId + '-content');
                const toggle = document.getElementById(sectionId + '-toggle');

                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    toggle.classList.remove('collapsed');
                    toggle.textContent = '▼';
                } else {
                    content.classList.add('collapsed');
                    toggle.classList.add('collapsed');
                    toggle.textContent = '▲';
                }
            }

            async function fetchFinancialData() {
                const paths = [

                    '/json/financials-data.min.json',
                ];

                for (const path of paths) {
                    try {
                        const response = await fetch(path);
                        if (!response.ok) continue;
                        financialData = await response.json();
                        initializeDashboard();
                        return;
                    } catch (error) {
                        console.error(`Error loading from ${path}:`, error);
                        continue;
                    }
                }

                // If we get here, none of the paths worked
                console.error('Could not load financial data from any path');
                document.getElementById('categories').innerHTML =
                    '<div class="error">Error loading financial data. Please try again later.</div>';
            }

            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            function getChangeClass(change) {
                if (change === "—" || change === "0" || change === "0.00") return 'change-neutral';
                if (change.startsWith('+')) return 'change-positive';
                if (change.startsWith('-')) return 'change-negative';
                return 'change-neutral';
            }

            function getArrowClass(change) {
                if (change === "—" || change === "0" || change === "0.00") return '';
                if (change.startsWith('+')) return 'arrow-up';
                if (change.startsWith('-')) return 'arrow-down';
                return '';
            }

            // Helper function to extract numeric value from string
            function extractNumericValue(value) {
                if (!value || value === '' || value.startsWith('TBD') || value === '—') return null;

                // Remove common prefixes and suffixes
                let cleanValue = value.toString()
                    .replace(/[$,%]/g, '') // Remove $ and %
                    .replace(/[+\-]/g, '') // Remove + and - signs
                    .replace(/[A-Za-z]/g, '') // Remove letters (M, B, etc.)
                    .trim();

                // Handle special cases like "134,391M" -> "134391"
                if (value.includes('M')) {
                    cleanValue = cleanValue.replace(/M$/, '');
                }
                if (value.includes('B')) {
                    cleanValue = cleanValue.replace(/B$/, '');
                }

                const num = parseFloat(cleanValue);
                return isNaN(num) ? null : num;
            }

            // Calculate Month-over-Month (MoM) change
            function calculateMoMChange(indicator) {
                const months = ['march', 'april', 'may', 'june', 'july', 'august'];
                let currentValue = null;
                let previousValue = null;
                let currentRawValue = '';

                // Find the latest available value and the previous one
                for (let i = months.length - 1; i >= 0; i--) {
                    const month = months[i];
                    const value = indicator[month];

                    if (value && value !== '' && !value.startsWith('TBD')) {
                        if (currentValue === null) {
                            currentValue = extractNumericValue(value);
                            currentRawValue = value;
                        } else if (previousValue === null) {
                            previousValue = extractNumericValue(value);
                            break;
                        }
                    }
                }

                if (currentValue === null || previousValue === null || previousValue === 0) {
                    return null;
                }

                const change = ((currentValue - previousValue) / previousValue) * 100;
                const numberChange = currentValue - previousValue;

                // Return both percentage change and number change
                return {
                    percentChange: change,
                    numberChange: numberChange,
                    currentRawValue: currentRawValue
                };
            }

            // Calculate Year-over-Year (YoY) change (comparing to same month last year)
            // For now, we'll use a simplified approach since we don't have last year's data
            function calculateYoYChange(indicator) {
                // This would require historical data from previous years
                // For now, return null to indicate no YoY data available
                return null;
            }

            // Format change percentage
            function formatChange(change) {
                if (change === null) return '—';
                const sign = change >= 0 ? '+' : '';
                return `${sign}${change.toFixed(2)}%`;
            }

            // Indicator explanations are now loaded from financials-data.min.json

            function createIndicatorCard(indicator) {
                const months = ['march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
                const monthLabels = ['Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                let dataRows = '';

                // Calculate MoM and YoY changes
                const momChange = calculateMoMChange(indicator);
                const yoyChange = calculateYoYChange(indicator);

                // Special handling for Polymarket FOMC BPS indicator
                if (indicator.name.includes('FOMC') && indicator.name.includes('Rate Decision (BPS)') && indicator.bps_probabilities) {
                    dataRows += `<div class="data-row"><span class="month-label">Next Meeting:</span> <span class="month-value">${indicator.next_meeting || ''}</span></div>`;
                    Object.entries(indicator.bps_probabilities).forEach(([bps, prob]) => {
                        if (prob && prob !== '') {
                            dataRows += `
                            <div class="data-row">
                                <span class="month-label">${bps}:</span>
                                <span class="month-value">${prob}</span>
                            </div>
                        `;
                        }
                    });
                } else {
                    months.forEach((month, index) => {
                        const value = indicator[month];
                        if (value && value !== '') {
                            dataRows += `
                            <div class="data-row">
                                <span class="month-label">${monthLabels[index]}:</span>
                                <span class="month-value">${value}</span>
                            </div>
                        `;
                        }
                    });
                }

                const url = indicator.url || '#';
                const explanation = indicator.explanation || '';

                // Create change indicators section
                let changeIndicators = '';

                // MoM change
                if (momChange !== null) {
                    const momFormatted = formatChange(momChange.percentChange);
                    let changeText = `MoM: ${momFormatted}`;

                    // Add number change for ADP Private Employment
                    if (indicator.name === 'Private Employment' && indicator.agency === 'ADP') {
                        const numberChange = momChange.numberChange;
                        const changeSign = numberChange >= 0 ? '+' : '';
                        const formattedNumber = numberChange.toLocaleString();
                        changeText += ` (${changeSign}${formattedNumber})`;
                    }

                    const arrowIcon = momChange.percentChange >= 0 ? '<i data-lucide="arrow-up-right"></i>' : '<i data-lucide="arrow-down-right"></i>';
                    changeIndicators += `
                    <div class="change-indicator ${getChangeClass(momFormatted)}" title="Month-over-Month (MoM) change calculated from available data.">
                        <span class="arrow-icon">${arrowIcon}</span> ${changeText}
                    </div>
                `;
                }

                // YoY change (placeholder for future implementation)
                if (yoyChange !== null) {
                    const yoyFormatted = formatChange(yoyChange);
                    const yoyArrowIcon = yoyChange >= 0 ? '<i data-lucide="arrow-up-right"></i>' : '<i data-lucide="arrow-down-right"></i>';
                    changeIndicators += `
                    <div class="change-indicator ${getChangeClass(yoyFormatted)}" title="Year-over-Year (YoY) change.">
                        <span class="arrow-icon">${yoyArrowIcon}</span> YoY: ${yoyFormatted}
                    </div>
                `;
                }

                return `
                <div class="indicator">
                    <div class="indicator-name">
                        ${indicator.name}
                        ${explanation ? `<i data-lucide="info" class="info-icon" data-explanation="${explanation.replace(/"/g, '&quot;')}" style="margin-left: 8px; width: 16px; height: 16px; color: var(--text-muted); cursor: pointer;"></i>` : ''}
                        ${['Shipping Container Rate (China-US 40ft)', 'CPI', 'PPI', 'Jobs Added', 'Housing Starts', 'New Home Sales', 'Industrial Production Index', 'Small Business Optimism Index', 'Jobless Claims', 'Job Openings', 'Private Employment', 'Affordability Index', 'Housing Market Index', 'Existing Home Sales', 'Number of Days on Market (Median)', 'Copper Futures', 'Lumber Futures', '20ft Equivalents (TEUs)'].includes(indicator.name) ? `<i data-lucide="bar-chart-3" class="chart-icon" style="margin-left: 8px; width: 16px; height: 16px; color: var(--accent-color, #2C5F5A); cursor: pointer;" title="View Interactive Chart"></i>` : ''}
                    </div>
                    <div class="indicator-agency">Source: <a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--text-muted); text-decoration: underline;">${indicator.agency}</a></div>
                    ${dataRows}
                    <div class="change-indicators">
                        ${changeIndicators}
                    </div>
                    <div class="explanation-text" style="display: none; margin-top: 8px; padding: 8px; background: var(--bg-secondary, #f5f5f5); border-radius: 4px; font-size: 0.9em; color: var(--text-secondary, #666);"></div>
                </div>
            `;
            }

            // Category icons mapping with Lucide icons
            const categoryIcons = {
                'Employment Indicators': '<i data-lucide="users"></i>',
                'Housing Market': '<i data-lucide="home"></i>',
                'Business Indicators': '<i data-lucide="briefcase"></i>',
                'Consumer Indicators': '<i data-lucide="shopping-cart"></i>',
                'Trade & Tariffs': '<i data-lucide="ship"></i>',
                'Government': '<i data-lucide="landmark"></i>',
                'Commodities': '<i data-lucide="package"></i>'
            };

            function setupInfoIconHandlers() {
                document.querySelectorAll('.info-icon').forEach(icon => {
                    icon.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();

                        const indicator = this.closest('.indicator');
                        const explanationDiv = indicator.querySelector('.explanation-text');
                        const explanation = this.dataset.explanation;

                        if (explanationDiv.style.display === 'none') {
                            explanationDiv.textContent = explanation;
                            explanationDiv.style.display = 'block';
                            this.style.color = 'var(--primary-color, #2C5F5A)';
                        } else {
                            explanationDiv.style.display = 'none';
                            this.style.color = 'var(--text-muted)';
                        }
                    });
                });
            }



            function renderDashboard(filterCategory = 'all') {
                const categoriesContainer = document.getElementById('categories');
                const categories = [...new Set(financialData.indices.map(item => item.category))];

                let html = '';

                categories.forEach(category => {
                    if (filterCategory !== 'all' && category !== filterCategory) return;

                    const categoryIndicators = financialData.indices.filter(item => item.category === category);
                    const icon = categoryIcons[category] || '<i data-lucide="bar-chart-2"></i>';

                    html += `
                    <div class="category" data-category="${category}">
                        <h2 class="category-title">
                            <span class="category-icon">${icon}</span>
                            <span class="category-name">${category}</span>
                        </h2>
                        <div class="indicators-grid">
                            ${categoryIndicators.map(indicator => createIndicatorCard(indicator)).join('')}
                        </div>
                    </div>
                `;
                });

                categoriesContainer.innerHTML = html;

                // Re-initialize Lucide icons after updating the content
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                // Add click event listeners for info icons
                setupInfoIconHandlers();
                setupChartIconHandlers();
            }

            function setupFilters() {
                const filtersContainer = document.getElementById('filters');
                const categories = [...new Set(financialData.indices.map(item => item.category))];

                // Clear existing filter buttons
                filtersContainer.innerHTML = '';

                // Create the 'All Categories' button (icon only, with tooltip)
                const allButton = document.createElement('button');
                allButton.className = 'filter-btn active';
                allButton.innerHTML = '<i data-lucide="list"></i>';
                allButton.dataset.category = 'all';
                allButton.setAttribute('aria-label', 'All Categories');
                allButton.setAttribute('data-tooltip', 'All Categories');
                filtersContainer.appendChild(allButton);

                // Create category filter buttons (icon only, with tooltip)
                categories.forEach(category => {
                    const button = document.createElement('button');
                    button.className = 'filter-btn';
                    const icon = categoryIcons[category] || '<i data-lucide="bar-chart-2"></i>';
                    button.innerHTML = `<span class="filter-icon">${icon}</span>`;
                    button.dataset.category = category;
                    button.setAttribute('aria-label', category);
                    button.setAttribute('data-tooltip', category);
                    filtersContainer.appendChild(button);
                });

                // Tooltip logic for hover and mobile/touch
                let tooltip = document.getElementById('filter-tooltip');
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.id = 'filter-tooltip';
                    tooltip.style.position = 'fixed';
                    tooltip.style.pointerEvents = 'none';
                    tooltip.style.zIndex = '9999';
                    tooltip.style.background = 'rgba(44,95,90,0.97)';
                    tooltip.style.color = '#fff';
                    tooltip.style.padding = '8px 12px';
                    tooltip.style.borderRadius = '6px';
                    tooltip.style.fontSize = '0.9em';
                    tooltip.style.fontWeight = '500';
                    tooltip.style.boxShadow = '0 4px 12px rgba(0,0,0,0.25)';
                    tooltip.style.transition = 'opacity 0.2s ease';
                    tooltip.style.opacity = '0';
                    tooltip.style.display = 'none';
                    tooltip.style.whiteSpace = 'nowrap';
                    tooltip.style.maxWidth = '200px';
                    tooltip.style.textAlign = 'center';
                    document.body.appendChild(tooltip);
                }

                function showTooltip(text, x, y) {
                    tooltip.textContent = text;
                    tooltip.style.display = 'block';

                    // Get actual tooltip dimensions after setting text
                    const tooltipRect = tooltip.getBoundingClientRect();
                    const tooltipWidth = tooltipRect.width;

                    // Center the tooltip horizontally and position it above the button
                    tooltip.style.left = Math.max(10, x - tooltipWidth / 2) + 'px';
                    tooltip.style.top = (y - 40) + 'px';
                    tooltip.style.opacity = '1';
                }
                function hideTooltip() {
                    tooltip.style.opacity = '0';
                    tooltip.style.display = 'none';
                    tooltip.dataset.activeButton = '';
                }

                // Combined click handler for filter buttons and tooltips
                filtersContainer.addEventListener('click', function (e) {
                    const btn = e.target.closest('.filter-btn');
                    if (btn) {
                        // Handle tooltip toggle on double-click or long press
                        if (e.detail === 2 && btn.dataset.tooltip) { // Double-click
                            const rect = btn.getBoundingClientRect();
                            tooltip.dataset.activeButton = btn.dataset.category;

                            requestAnimationFrame(() => {
                                showTooltip(btn.dataset.tooltip, rect.left + rect.width / 2, rect.top);
                            });

                            // Auto-hide after 3 seconds
                            setTimeout(() => {
                                if (tooltip.dataset.activeButton === btn.dataset.category) {
                                    hideTooltip();
                                }
                            }, 3000);
                            return;
                        }

                        // Handle filter change (single click)
                        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                        btn.classList.add('active');
                        renderDashboard(btn.dataset.category);

                        // Hide any existing tooltip
                        hideTooltip();
                    }
                });

                // Hide tooltip when clicking outside
                document.addEventListener('click', function (e) {
                    if (!filtersContainer.contains(e.target)) {
                        hideTooltip();
                    }
                });

                // Initialize Lucide icons after creating filter buttons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }

            function initializeDashboard() {
                document.getElementById('lastUpdated').textContent = `Last Updated: ${formatDate(financialData.lastUpdated)}`;
                setupFilters();
                renderDashboard();
                setupModalHandlers();
            }

            // Initialize dashboard
            document.addEventListener('DOMContentLoaded', function () {
                fetchFinancialData();
                // Initialize Lucide icons when DOM is ready
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            });
        </script>
        <script src="/js/dark-mode.js" defer></script>
        <script src="/js/portfolio.min.js" defer></script>
        <script src="/js/nav.min.js?v=20250723" defer></script>
        <div id="last-updated" style="text-align: center; margin-top: 2rem; color: #666; font-size: 0.9em;"></div>
        <script src="js/portfolio.min.js"></script>
        <script>
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        </script>
</body>

</html>